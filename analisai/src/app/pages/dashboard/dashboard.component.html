<div class="dashboard">
  <analisai-sidebar></analisai-sidebar>

  <div class="content">
    <header>
      <h1>Vis√£o Geral</h1>
      <p>Insights gerados pela IA com base no backlog do Jira</p>
    </header>

    <section class="kpis">
      <div class="kpi">
        <small>Total de Tarefas</small>
        <h2>{{ stats?.totalTasks || 0 }}</h2>
      </div>
      
      <div class="kpi">
        <small>Em Atraso</small>
        <h2 [style.color]="(stats?.delayedTasks || 0) > 0 ? '#ff6b6b' : 'white'">
          {{ stats?.delayedTasks || 0 }}
        </h2>
      </div>

      <div class="kpi">
        <small>Em Progresso</small>
        <h2 style="color: #ffd978">{{ stats?.inProgressTasks || 0 }}</h2>
      </div>

      <div class="kpi">
        <small>Conclu√≠das</small>
        <h2 style="color: #4cd964">{{ stats?.completedTasks || 0 }}</h2>
      </div>

      <div class="kpi">
        <small>Progresso Global</small>
        <h2>{{ getPercentual() }}%</h2>
      </div>
    </section>

    <section class="tasks">
      <h2>Lista de Tarefas do Jira</h2>
      
      <div *ngIf="loading" style="text-align: center; padding: 2rem; color: #9dbce1;">
        <i class="fas fa-spinner fa-spin"></i> Carregando dados do Jira...
      </div>

      <table *ngIf="!loading">
        <thead>
          <tr>
            <th>Chave</th>
            <th>Resumo</th>
            <th>Respons√°vel</th>
            <th>Status</th>
            <th>Prazo (Due Date)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let task of tasks" (click)="openAnalysis(task)">
            <td style="color: #9dbce1; font-size: 0.85rem;">{{ task.key }}</td>
            
            <td>{{ task.summary }}</td>
            
            <td>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div style="width: 24px; height: 24px; background: #2c5cff; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                  {{ task.assignee ? task.assignee.charAt(0) : '?' }}
                </div>
                {{ task.assignee || 'N√£o atribu√≠do' }}
              </div>
            </td>

            <td>
              <span [class]="task.status.toLowerCase().replace(' ', '-')">
                {{ task.status }}
              </span>
            </td>

            <td>{{ task.duedate || '---' }}</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="cards">
      <div class="card">
        <h3>Proje√ß√µes de Prazos</h3>
        <div class="placeholder">
          <p style="color: #9dbce1">Gr√°fico de Burnup em desenvolvimento...</p>
        </div>
      </div>
      <div class="card">
        <h3>Recomenda√ß√µes R√°pidas</h3>
        <ul class="updates">
          <li>üîç Clique em uma tarefa na tabela para ver a an√°lise detalhada da IA.</li>
          <li>‚ö†Ô∏è Verifique as {{ stats?.delayedTasks || 0 }} tarefas que est√£o marcadas como atrasadas.</li>
        </ul>
      </div>
    </section>
  </div>

  <div class="chat-box">
    <div class="chat-header">
      <i class="fa-solid fa-robot"></i> <span>AnalisAI</span>
    </div>
    <div class="chat-messages">
      <div *ngFor="let msg of messages" class="message" [ngClass]="msg.sender">
        <p>{{ msg.text }}</p>
      </div>
    </div>
    <div class="chat-input">
      <input 
        [(ngModel)]="userInput" 
        (keyup.enter)="sendMessage()" 
        type="text" 
        placeholder="Pergunte algo √† IA..." 
      />
      <button (click)="sendMessage()">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>
  </div>

  <div class="analysis-panel" [class.active]="showAnalysis">
    <div class="header">
      <h3>An√°lise da IA</h3>
      <button class="close" (click)="closeAnalysis()">√ó</button>
    </div>

    <div *ngIf="selectedTask" class="content-panel">
      <div style="margin-bottom: 1.5rem; border-bottom: 1px solid #1e3f6d; padding-bottom: 1rem;">
        <span style="background: #2b6eff; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">{{ selectedTask.key }}</span>
        <h4 style="margin-top: 0.5rem; color: white;">{{ selectedTask.summary }}</h4>
      </div>

      <div *ngIf="analyzing" style="text-align: center; padding: 2rem; color: #9dbce1;">
        <p>ü§ñ A IA est√° analisando riscos e depend√™ncias...</p>
        <div class="loading-spinner"></div> 
        </div>

      <div *ngIf="!analyzing && aiAnalysisResult">
        
        <div class="section" *ngIf="aiAnalysisResult.riscosIdentificados?.length">
          <h5 style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> Riscos Identificados</h5>
          <ul>
            <li *ngFor="let risco of aiAnalysisResult.riscosIdentificados">{{ risco }}</li>
          </ul>
        </div>

        <div class="section" *ngIf="aiAnalysisResult.dependenciasObrigatorias?.length">
          <h5 style="color: #ffd978;"><i class="fas fa-link"></i> Depend√™ncias</h5>
          <ul>
            <li *ngFor="let dep of aiAnalysisResult.dependenciasObrigatorias">{{ dep }}</li>
          </ul>
        </div>

        <div class="section" *ngIf="aiAnalysisResult.sugestoesOtimizacao?.length">
          <h5 style="color: #4cd964;"><i class="fas fa-rocket"></i> Sugest√µes de Otimiza√ß√£o</h5>
          <ul>
            <li *ngFor="let sug of aiAnalysisResult.sugestoesOtimizacao">{{ sug }}</li>
          </ul>
        </div>

        <button class="apply" (click)="closeAnalysis()">Entendido</button>
      </div>

      <div *ngIf="!analyzing && !aiAnalysisResult">
        <p>N√£o foi poss√≠vel gerar a an√°lise no momento.</p>
      </div>

    </div>
  </div>
</div>
